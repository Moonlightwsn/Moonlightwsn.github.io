<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>H5å®šä½åŠŸèƒ½è§£å†³æ–¹æ¡ˆ - å¢å¼ºç‰ˆ</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
      }

      body {
        background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        width: 100%;
        max-width: 500px;
        padding: 30px;
        text-align: center;
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
        font-weight: 600;
      }

      .description {
        color: #666;
        margin-bottom: 30px;
        line-height: 1.6;
      }

      .status-card {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        transition: all 0.3s ease;
      }

      .status-icon {
        font-size: 48px;
        margin-bottom: 15px;
      }

      .status-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 10px;
      }

      .status-description {
        color: #666;
        font-size: 14px;
        line-height: 1.5;
      }

      .location-info {
        text-align: left;
        background: #e8f4fd;
        border-radius: 10px;
        padding: 15px;
        margin: 20px 0;
        display: none;
      }

      .location-info h3 {
        color: #1976d2;
        margin-bottom: 10px;
      }

      .location-info p {
        margin-bottom: 5px;
        color: #333;
      }

      .error-info {
        text-align: left;
        background: #ffebee;
        border-radius: 10px;
        padding: 15px;
        margin: 20px 0;
        display: none;
      }

      .error-info h3 {
        color: #d32f2f;
        margin-bottom: 10px;
      }

      .error-info p {
        margin-bottom: 5px;
        color: #333;
      }

      .action-btn {
        background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        color: white;
        border: none;
        border-radius: 50px;
        padding: 14px 30px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(37, 117, 252, 0.4);
        width: 100%;
        margin-top: 10px;
      }

      .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(37, 117, 252, 0.6);
      }

      .action-btn:active {
        transform: translateY(0);
      }

      .action-btn:disabled {
        background: #cccccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .retry-btn {
        background: #ff9800;
        margin-top: 5px;
      }

      .tips {
        margin-top: 25px;
        padding-top: 20px;
        border-top: 1px solid #eee;
        text-align: left;
      }

      .tips h3 {
        color: #333;
        margin-bottom: 10px;
        font-size: 16px;
      }

      .tips ul {
        padding-left: 20px;
        color: #666;
        font-size: 14px;
        line-height: 1.6;
      }

      .tips li {
        margin-bottom: 8px;
      }

      .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
        margin-right: 10px;
        vertical-align: middle;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .hidden {
        display: none;
      }

      .browser-info {
        background: #e8f5e9;
        border-radius: 10px;
        padding: 15px;
        margin: 15px 0;
        text-align: left;
        font-size: 14px;
      }

      .browser-info h3 {
        color: #2e7d32;
        margin-bottom: 8px;
      }

      .debug-info {
        background: #f3e5f5;
        border-radius: 10px;
        padding: 15px;
        margin: 15px 0;
        text-align: left;
        font-size: 14px;
        display: none;
      }

      .debug-info h3 {
        color: #7b1fa2;
        margin-bottom: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ä½ç½®ä¿¡æ¯æœåŠ¡ - å¢å¼ºç‰ˆ</h1>
      <p class="description">è·å–æ‚¨å½“å‰çš„ä½ç½®ä¿¡æ¯ï¼Œä¸ºæ‚¨æä¾›æ›´å¥½çš„æœåŠ¡ä½“éªŒ</p>

      <div class="browser-info">
        <h3>æµè§ˆå™¨ä¿¡æ¯</h3>
        <p id="browserDetails">æ­£åœ¨æ£€æµ‹æµè§ˆå™¨ä¿¡æ¯...</p>
      </div>

      <div class="status-card" id="statusCard">
        <div class="status-icon">ğŸ“</div>
        <h2 class="status-title" id="statusTitle">å‡†å¤‡è·å–ä½ç½®ä¿¡æ¯</h2>
        <p class="status-description" id="statusDescription">
          ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹è·å–æ‚¨çš„ä½ç½®ä¿¡æ¯
        </p>
      </div>

      <div class="location-info" id="locationInfo">
        <h3>ä½ç½®ä¿¡æ¯</h3>
        <p><strong>çº¬åº¦:</strong> <span id="latitude">-</span></p>
        <p><strong>ç»åº¦:</strong> <span id="longitude">-</span></p>
        <p><strong>ç²¾åº¦:</strong> <span id="accuracy">-</span> ç±³</p>
        <p><strong>æ›´æ–°æ—¶é—´:</strong> <span id="timestamp">-</span></p>
      </div>

      <div class="error-info" id="errorInfo">
        <h3>è·å–ä½ç½®å¤±è´¥</h3>
        <p id="errorMessage">æœªçŸ¥é”™è¯¯</p>
      </div>

      <div class="debug-info" id="debugInfo">
        <h3>è°ƒè¯•ä¿¡æ¯</h3>
        <p id="debugDetails"></p>
      </div>

      <button class="action-btn" id="getLocationBtn">è·å–æˆ‘çš„ä½ç½®</button>

      <button class="action-btn retry-btn" id="retryBtn" style="display: none">
        é‡æ–°å°è¯•å®šä½
      </button>

      <div class="tips">
        <h3>å®šä½é—®é¢˜æ’æŸ¥æç¤ºï¼š</h3>
        <ul>
          <li>ç¡®ä¿æ‚¨å·²æˆæƒæ­¤ç½‘ç«™è·å–ä½ç½®ä¿¡æ¯</li>
          <li>æ£€æŸ¥è®¾å¤‡å®šä½åŠŸèƒ½æ˜¯å¦å·²å¼€å¯</li>
          <li>å°è¯•åœ¨å®¤å¤–æˆ–ä¿¡å·è¾ƒå¥½çš„åœ°æ–¹ä½¿ç”¨</li>
          <li>æŸäº›æµè§ˆå™¨éœ€è¦HTTPSåè®®æ‰èƒ½ä½¿ç”¨å®šä½åŠŸèƒ½</li>
          <li>å¦‚æœä½¿ç”¨VPNï¼Œè¯·å°è¯•å…³é—­åé‡è¯•</li>
          <li>å°è¯•æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å’Œä½ç½®æƒé™åé‡æ–°æˆæƒ</li>
          <li>æŸäº›æµè§ˆå™¨åœ¨éšç§æ¨¡å¼ä¸‹å¯èƒ½é™åˆ¶å®šä½åŠŸèƒ½</li>
        </ul>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const statusCard = document.getElementById("statusCard");
        const statusTitle = document.getElementById("statusTitle");
        const statusDescription = document.getElementById("statusDescription");
        const locationInfo = document.getElementById("locationInfo");
        const errorInfo = document.getElementById("errorInfo");
        const debugInfo = document.getElementById("debugInfo");
        const getLocationBtn = document.getElementById("getLocationBtn");
        const retryBtn = document.getElementById("retryBtn");
        const latitude = document.getElementById("latitude");
        const longitude = document.getElementById("longitude");
        const accuracy = document.getElementById("accuracy");
        const timestamp = document.getElementById("timestamp");
        const errorMessage = document.getElementById("errorMessage");
        const debugDetails = document.getElementById("debugDetails");
        const browserDetails = document.getElementById("browserDetails");

        let retryCount = 0;
        const maxRetries = 2;
        let currentWatchId = null;

        // æ˜¾ç¤ºæµè§ˆå™¨ä¿¡æ¯
        displayBrowserInfo();

        // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒåœ°ç†ä½ç½®API
        if (!navigator.geolocation) {
          showError("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®æœåŠ¡");
          getLocationBtn.disabled = true;
          return;
        }

        getLocationBtn.addEventListener("click", startLocationProcess);
        retryBtn.addEventListener("click", startLocationProcess);

        function startLocationProcess() {
          retryCount = 0;
          getLocationWithRetry();
        }

        function getLocationWithRetry() {
          // æ›´æ–°çŠ¶æ€
          updateStatus(
            "æ­£åœ¨è·å–ä½ç½®...",
            `è¯·ç¨å€™ï¼Œç³»ç»Ÿæ­£åœ¨å°è¯•è·å–æ‚¨çš„ä½ç½®ä¿¡æ¯${
              retryCount > 0 ? ` (ç¬¬${retryCount + 1}æ¬¡å°è¯•)` : ""
            }`,
            "#fff3cd",
            "ğŸ”„"
          );
          getLocationBtn.disabled = true;
          retryBtn.style.display = "none";
          getLocationBtn.innerHTML = '<span class="spinner"></span>è·å–ä¸­...';

          // éšè—ä¹‹å‰çš„ç»“æœ
          locationInfo.style.display = "none";
          errorInfo.style.display = "none";
          debugInfo.style.display = "none";

          // åœæ­¢ä¹‹å‰çš„ç›‘å¬
          if (currentWatchId !== null) {
            navigator.geolocation.clearWatch(currentWatchId);
            currentWatchId = null;
          }

          // è·å–ä½ç½®ä¿¡æ¯ - ä½¿ç”¨watchPositionè€Œä¸æ˜¯getCurrentPosition
          // è¿™æ ·å¯ä»¥æ›´å¥½åœ°å¤„ç†è¶…æ—¶å’Œæä¾›æ›´å®æ—¶çš„åé¦ˆ
          const options = {
            enableHighAccuracy: true,
            timeout: 15000, // å¢åŠ åˆ°15ç§’
            maximumAge: 0, // ä¸ä½¿ç”¨ç¼“å­˜ä½ç½®
          };

          currentWatchId = navigator.geolocation.watchPosition(
            // æˆåŠŸå›è°ƒ
            function (position) {
              // æ¸…é™¤ç›‘å¬
              if (currentWatchId !== null) {
                navigator.geolocation.clearWatch(currentWatchId);
                currentWatchId = null;
              }

              const lat = position.coords.latitude;
              const lng = position.coords.longitude;
              const acc = position.coords.accuracy;
              const time = new Date(position.timestamp).toLocaleString();

              // æ›´æ–°ç•Œé¢æ˜¾ç¤ºä½ç½®ä¿¡æ¯
              latitude.textContent = lat.toFixed(6);
              longitude.textContent = lng.toFixed(6);
              accuracy.textContent = Math.round(acc);
              timestamp.textContent = time;

              // æ˜¾ç¤ºä½ç½®ä¿¡æ¯
              locationInfo.style.display = "block";

              // æ›´æ–°çŠ¶æ€
              updateStatus(
                "ä½ç½®è·å–æˆåŠŸ",
                "å·²æˆåŠŸè·å–æ‚¨çš„ä½ç½®ä¿¡æ¯",
                "#d4edda",
                "âœ…"
              );

              // æ¢å¤æŒ‰é’®çŠ¶æ€
              getLocationBtn.disabled = false;
              getLocationBtn.textContent = "é‡æ–°è·å–ä½ç½®";
              retryBtn.style.display = "none";

              // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
              showDebugInfo(
                `å®šä½æˆåŠŸ - ç²¾åº¦: ${Math.round(
                  acc
                )}ç±³, æ–¹æ³•: ${getPositionMethod(position)}`
              );
            },
            // é”™è¯¯å›è°ƒ
            function (error) {
              // æ¸…é™¤ç›‘å¬
              if (currentWatchId !== null) {
                navigator.geolocation.clearWatch(currentWatchId);
                currentWatchId = null;
              }

              let message = "";
              let debugMsg = "";

              switch (error.code) {
                case error.PERMISSION_DENIED:
                  message =
                    "ä½ç½®è¯·æ±‚è¢«æ‹’ç»ã€‚è¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®å¹¶å…è®¸ä½ç½®è®¿é—®æƒé™ã€‚";
                  debugMsg = "æƒé™è¢«æ‹’ç» - ç”¨æˆ·æ‹’ç»äº†ä½ç½®è®¿é—®è¯·æ±‚";
                  break;
                case error.POSITION_UNAVAILABLE:
                  message =
                    "ä½ç½®ä¿¡æ¯ä¸å¯ç”¨ã€‚è¯·æ£€æŸ¥æ‚¨çš„è®¾å¤‡å®šä½åŠŸèƒ½æ˜¯å¦å·²å¼€å¯ã€‚";
                  debugMsg = "ä½ç½®ä¸å¯ç”¨ - è®¾å¤‡å®šä½æœåŠ¡å¯èƒ½å·²å…³é—­";
                  break;
                case error.TIMEOUT:
                  debugMsg = `å®šä½è¶…æ—¶ - å°è¯•${retryCount + 1}æ¬¡åä»è¶…æ—¶`;
                  if (retryCount < maxRetries) {
                    // é‡è¯•
                    retryCount++;
                    setTimeout(getLocationWithRetry, 1000);
                    updateStatus(
                      "æ­£åœ¨é‡è¯•...",
                      `ç¬¬${retryCount + 1}æ¬¡å°è¯•è·å–ä½ç½®`,
                      "#ffeaa7",
                      "ğŸ”„"
                    );
                    return;
                  } else {
                    message =
                      "è·å–ä½ç½®è¶…æ—¶ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºï¼š1) GPSä¿¡å·å¼± 2) ç½‘ç»œè¿æ¥é—®é¢˜ 3) æµè§ˆå™¨å®šä½æœåŠ¡å“åº”æ…¢ã€‚è¯·å°è¯•åœ¨å¼€é˜”åœ°å¸¦ä½¿ç”¨æˆ–æ›´æ¢æµè§ˆå™¨ã€‚";
                  }
                  break;
                default:
                  message = "å‘ç”ŸæœªçŸ¥é”™è¯¯ï¼Œæ— æ³•è·å–ä½ç½®ä¿¡æ¯ã€‚";
                  debugMsg = `æœªçŸ¥é”™è¯¯ - é”™è¯¯ä»£ç : ${error.code}`;
                  break;
              }

              // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
              showError(message);
              showDebugInfo(debugMsg);

              // æ¢å¤æŒ‰é’®çŠ¶æ€
              getLocationBtn.disabled = false;
              getLocationBtn.textContent = "é‡æ–°è·å–ä½ç½®";
              retryBtn.style.display = "block";
            },
            options
          );

          // è®¾ç½®å¤‡ç”¨è¶…æ—¶ - é˜²æ­¢watchPositionä¸è§¦å‘è¶…æ—¶é”™è¯¯
          setTimeout(() => {
            if (currentWatchId !== null) {
              navigator.geolocation.clearWatch(currentWatchId);
              currentWatchId = null;

              if (retryCount < maxRetries) {
                retryCount++;
                setTimeout(getLocationWithRetry, 1000);
                updateStatus(
                  "æ­£åœ¨é‡è¯•...",
                  `ç¬¬${retryCount + 1}æ¬¡å°è¯•è·å–ä½ç½®`,
                  "#ffeaa7",
                  "ğŸ”„"
                );
              } else {
                showError(
                  "è·å–ä½ç½®è¶…æ—¶ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºï¼š1) GPSä¿¡å·å¼± 2) ç½‘ç»œè¿æ¥é—®é¢˜ 3) æµè§ˆå™¨å®šä½æœåŠ¡å“åº”æ…¢ã€‚è¯·å°è¯•åœ¨å¼€é˜”åœ°å¸¦ä½¿ç”¨æˆ–æ›´æ¢æµè§ˆå™¨ã€‚"
                );
                showDebugInfo(`å¤‡ç”¨è¶…æ—¶è§¦å‘ - å°è¯•${retryCount}æ¬¡åä»æ— å“åº”`);

                getLocationBtn.disabled = false;
                getLocationBtn.textContent = "é‡æ–°è·å–ä½ç½®";
                retryBtn.style.display = "block";
              }
            }
          }, 16000); // æ¯”watchPositionçš„è¶…æ—¶æ—¶é—´ç¨é•¿
        }

        function getPositionMethod(position) {
          // å°è¯•æ£€æµ‹å®šä½æ–¹æ³• (éæ ‡å‡†å±æ€§ï¼Œéƒ¨åˆ†æµè§ˆå™¨æ”¯æŒ)
          if (position.coords.altitude !== null) {
            return "å¯èƒ½ä½¿ç”¨GPS";
          } else if (position.coords.accuracy > 1000) {
            return "IPå®šä½";
          } else {
            return "ç½‘ç»œå®šä½(WiFi/åŸºç«™)";
          }
        }

        function displayBrowserInfo() {
          const ua = navigator.userAgent;
          let browserName = "æœªçŸ¥æµè§ˆå™¨";

          if (ua.includes("Chrome") && !ua.includes("Edg")) {
            browserName = "Google Chrome";
          } else if (ua.includes("Firefox")) {
            browserName = "Mozilla Firefox";
          } else if (ua.includes("Safari") && !ua.includes("Chrome")) {
            browserName = "Apple Safari";
          } else if (ua.includes("Edg")) {
            browserName = "Microsoft Edge";
          } else if (ua.includes("Trident") || ua.includes("MSIE")) {
            browserName = "Internet Explorer";
          }

          browserDetails.innerHTML = `
                    <strong>æµè§ˆå™¨:</strong> ${browserName}<br>
                    <strong>User Agent:</strong> ${ua.substring(0, 80)}${
            ua.length > 80 ? "..." : ""
          }<br>
                    <strong>HTTPS:</strong> ${
                      window.location.protocol === "https:" ? "æ˜¯" : "å¦"
                    }<br>
                    <strong>å®šä½APIæ”¯æŒ:</strong> ${
                      navigator.geolocation ? "æ˜¯" : "å¦"
                    }
                `;
        }

        function updateStatus(title, description, backgroundColor, icon) {
          statusTitle.textContent = title;
          statusDescription.textContent = description;
          statusCard.style.backgroundColor = backgroundColor;

          const statusIcon = statusCard.querySelector(".status-icon");
          statusIcon.textContent = icon;
        }

        function showError(message) {
          errorMessage.textContent = message;
          errorInfo.style.display = "block";
          updateStatus(
            "è·å–ä½ç½®å¤±è´¥",
            "æ— æ³•è·å–æ‚¨çš„ä½ç½®ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ä¸‹æ–¹é”™è¯¯è¯¦æƒ…",
            "#f8d7da",
            "âŒ"
          );
        }

        function showDebugInfo(info) {
          debugDetails.textContent = info;
          debugInfo.style.display = "block";
        }
      });
    </script>
  </body>
</html>
