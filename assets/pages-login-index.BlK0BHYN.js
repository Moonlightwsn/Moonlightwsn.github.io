import{d as e,a4 as s,l as a,a5 as o,a6 as t,a7 as r,S as l,a as n,o as i,i as p,n as c,b as d,w as u,r as m,f,a8 as g,W as h,Y as y,a9 as x,aa as v,ab as b,ac as _,j as w,m as k,q as j,e as C,u as z,L as S,_ as $,h as O}from"./index-CQJqgjxr.js";import{_ as V}from"./wd-text.Bc2ux5Th.js";import{s as q}from"./routerHelper.Dx0aW15T.js";import{u as E}from"./index.DEKZD6wB.js";import{M as U}from"./index.CYBLn4NN.js";import"./alova.esm.BwIAK7PD.js";const T=w(e({name:"wd-form",options:{addGlobalClass:!0,virtualHost:!0,styleIsolation:"shared"},props:s,setup(e,{expose:s}){const{show:w}=a("wd-form-toast"),k=e,{children:j,linkChildren:C}=o(t);let z=r({});function S(e){e?z[e]="":Object.keys(z).forEach(e=>{z[e]=""})}return C({props:k,errorMessages:z}),l(()=>k.model,()=>{k.resetOnChange&&S()},{immediate:!0,deep:!0}),s({validate:async function(e){const s=[];let a=!0;const o=[],t=function(){const e=_(k.rules),s=j.map(e=>e.prop);return Object.keys(e).forEach(a=>{s.includes(a)||delete e[a]}),j.forEach(s=>{y(s.prop)&&y(s.rules)&&s.rules.length&&(e[s.prop]?e[s.prop]=[...e[s.prop],...s.rules]:e[s.prop]=s.rules)}),e}(),r=h(e)?e:y(e)?[e]:[],l=r.length>0?r.reduce((e,s)=>(t[s]&&(e[s]=t[s]),e),{}):t;for(const n in l){const e=l[n],t=x(k.model,n);if(e&&e.length>0)for(const r of e){if(r.required&&(!y(t)||""===t)){s.push({prop:n,message:r.message}),a=!1;break}if(r.pattern&&!r.pattern.test(t)){s.push({prop:n,message:r.message}),a=!1;break}const{validator:e,...l}=r;if(e){const i=e(t,l);v(i)?o.push(i.then(e=>{"string"==typeof e?(s.push({prop:n,message:e}),a=!1):"boolean"!=typeof e||e||(s.push({prop:n,message:r.message}),a=!1)}).catch(e=>{const o=y(e)?b(e)?e:e.message||r.message:r.message;s.push({prop:n,message:o}),a=!1})):i||(s.push({prop:n,message:r.message}),a=!1)}}}return await Promise.all(o),function(e){const s=j.map(e=>e.prop).filter(Boolean),a=e.filter(e=>e.message&&s.includes(e.prop));a.length&&(a.sort((e,a)=>s.indexOf(e.prop)-s.indexOf(a.prop)),"toast"===k.errorType?w(a[0].message):"message"===k.errorType&&a.forEach(e=>{z[e.prop]=e.message}))}(s),a&&(r.length?r.forEach(S):S()),{valid:a,errors:s}},reset:function(){S()}}),(e,s)=>{const a=p;return i(),n(a,{class:d(`wd-form ${e.customClass}`),style:c(e.customStyle)},{default:u(()=>[m(e.$slots,"default",{},void 0,!0),"toast"===k.errorType?(i(),n(g,{key:0,selector:"wd-form-toast"})):f("",!0)]),_:3},8,["class","style"])}}}),[["__scopeId","data-v-e513a788"]]),B=e({__name:"index",setup(e){const s=E("access_token",""),o=a(),t=k(),l=r({mobile:"",code:""});async function c(){await t.value.validate();const e=await U.app.sendSmsCode({data:{mobile:l.mobile,scene:1}});0===(null==e?void 0:e.code)&&o.success("验证码已发送")}async function d(){await t.value.validate();const e=await U.app.smsLogin({data:{...l}});if(0===(null==e?void 0:e.code)){const{accessToken:a}=(null==e?void 0:e.data)||{};a&&(s.value=a,o.success({msg:"登录成功",closed(){q("profit")}}))}else o.error((null==e?void 0:e.msg)||"登录失败")}const m=/^\d{11}$/;function f(e){return!(l.mobile&&m.test(l.mobile)&&!e)}const g=k(!1);async function h(){var e,s;if(!g.value)try{o.loading({msg:"加载中...",duration:0}),g.value=!0;const a=await U.app.caRegisterSign();if(0===a.code&&a.data){const{baseUrl:o,path:t,clientId:r,timestamp:l,signature:n,redirectUri:i,appBizNo:p}=a.data,c=(e=`${o}${t}`,s={client_env:"h5",client_id:r,timestamp:l,signature:n,redirect_uri:i,app_biz_no:p},`${e}?${new URLSearchParams({...s,timestamp:s.timestamp.toString()}).toString()}`);window.location.href=c}}finally{o.close(),g.value=!1}}return(e,s)=>{const a=p,o=V,r=S,y=$,x=T,v=j("layout-default-uni");return i(),n(v,null,{default:u(()=>[C(a,{class:"flex h-screen w-screen flex-col items-center justify-center gap-2 overflow-hidden"},{default:u(()=>[C(a,{class:"h-160rpx w-160rpx rounded-2xl bg-[var(--wot-color-theme)]"}),C(o,{text:"数字存根馆",size:"48rpx",color:"#000"}),C(o,{text:"您的数字权益管理平台"}),C(a,{class:"mt-4 w-full px-6"},{default:u(()=>[C(x,{ref_key:"form",ref:t,class:"flex flex-col gap-4",model:z(l)},{default:u(()=>[C(r,{modelValue:z(l).mobile,"onUpdate:modelValue":s[0]||(s[0]=e=>z(l).mobile=e),class:"rounded-xl","no-border":"",size:"large",prop:"mobile",placeholder:"请输入手机号",rules:[{required:!0,message:"请输入手机号"},{required:!1,pattern:m,message:"手机号格式不正确"}]},null,8,["modelValue","rules"]),C(r,{modelValue:z(l).code,"onUpdate:modelValue":s[1]||(s[1]=e=>z(l).code=e),class:"rounded-xl","no-border":"",size:"large",prop:"code",type:"number","input-mode":"numeric",placeholder:"请输入验证码",rules:[{required:!1,validator:f,message:"请输入验证码"}]},{suffix:u(()=>[C(y,{type:"primary",size:"small",onClick:c},{default:u(()=>[O(" 获取验证码 ")]),_:1})]),_:1},8,["modelValue","rules"]),C(a,null,{default:u(()=>[C(y,{block:"",size:"large",round:!1,onClick:d},{default:u(()=>[O(" 登录 ")]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),C(a,null,{default:u(()=>[C(o,{text:"还没有账号？"}),C(o,{text:"立即注册",type:z(g)?"default":"primary",onClick:h},null,8,["type"])]),_:1})]),_:1})]),_:1})}}});export{B as default};
